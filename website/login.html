<html>
  <head>
      <title>GriffinCoin - Authorize</title>
      <!-- Favicon -->
      <link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png">
      <link rel="manifest" href="/static/favicons/site.webmanifest">
      <meta name="msapplication-TileColor" content="#da532c">
      <meta name="theme-color" content="#ffffff"> 
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" referrerpolicy="no-referrer" />
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/textillate/0.4.0/jquery.textillate.min.js" integrity="sha512-0bHMhYsdpiur1bT84kDH4D7cpxFQ9O7uA5yxVAqWC87h552Xt0swX4M+ZlXMKE8oPVRIJ5lAwXWO2UWeDwJJOw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lettering.js/0.7.0/jquery.lettering.min.js" integrity="sha512-9ex1Kp3S7uKHVZmQ44o5qPV6PnP8/kYp8IpUHLDJ+GZ/qpKAqGgEEH7rhYlM4pTOSs/WyHtPubN2UePKTnTSww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.0/dist/js.cookie.min.js"></script>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
      
      <style>
        ::placeholder {
          font-size: .65rem;
        }

        a kbd:hover{
          color:rgb(51,255,51) !important;
        }

        .hacker:hover{
          font-size:1.05rem
        }
      </style>
  </head>
  <body>
      <!-- nav -->
      <nav class="sticky-top navbar navbar-expand-lg navbar-light bg-light">
          <div class="container">
            <a class="navbar-brand mr-3" href="/?id=banner">
              <img src="https://hackerspace.govhack.org/assets/logo-footer-91aec9295ddf37950968f2a51d0dbcfdbcf479920bd4d6d04d368c531143ef2e.svg" alt="logo" height="60">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbar">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  <a id='h0' class="nav-link active" aria-current="page" href="/?id=banner">Home</a>
                </li>
                <li class="nav-item">
                  <a id='h1' class="nav-link" href="/?id=about">About</a>
                </li>
              </ul>
              <a class="text-decoration-none" href="./login"><kbd>$ ./login.sh</kbd></a>
              <small style="margin-left: .5rem;margin-right: .5rem;">/</small>
              <a class="text-decoration-none" href="./login?act=signup"><kbd>$ ./signup.sh</kbd></a>
            </div>
          </div>
      </nav>

      <!-- signup -->
      <div id="signup" class="container pt-2 w-25 shadow-lg" style="border-radius: 15px;margin-top:4rem">
        <div class="p-4">
          <div id="signupAlert" class="mb-3">
            <h3 class="text-center mb-3 font-monospace">Sign Up</h1>
          </div>
            <div class="mb-3">
              <label for="s_username" class="form-label font-monospace">Username</label>
              <input type="email" class="form-control fs-6 font-monospace" id="s_username" placeholder="len(username) >= 5 and ' ' not in username">
            </div>
            <div class="mb-3">
              <label for="s_password" class="form-label font-monospace">Password</label>
              <input type="password" class="form-control fs-6 font-monospace" id="s_password" placeholder=" 5 <= len(password) <= 255"></textarea>
            </div>
            <div class="mt-4 mb-2 text-center">
              <a class="mt-2 text-decoration-none mb-5" href="javascript:signup()"><kbd class="hacker">$ ./do-signup.sh</kbd></a>
            </div>
          </div>
      </div>

      <!-- login -->
      <div id="login" class="container pt-2 w-25 shadow-lg" style="border-radius: 15px;margin-top:4rem">
        <div class="p-4">
          <div id="loginAlert" class="mb-3">
            <h3 class="text-center mb-3 font-monospace">Login</h1>
          </div>
            <div class="mb-3">
              <label for="l_username" class="form-label font-monospace">Username</label>
              <input type="text" class="form-control fs-6 font-monospace" id="l_username" placeholder="len(username) >= 5 and ' ' not in username">
            </div>
            <div class="mb-3">
              <label for="l_password" class="form-label font-monospace">Password</label>
              <input type="password" class="form-control fs-6 font-monospace" id="l_password" placeholder=" 8 <= len(password) <= 255"></textarea>
            </div>
            <div class="mt-4 mb-2 text-center">
              <a class="mt-2 text-decoration-none mb-5" href="javascript:login()"><kbd class="hacker">$ ./do-login.sh</kbd></a>
            </div>
          </div>
      </div>

      <script>
          function getUrlParam(name) {
              var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
              var r = window.location.search.substr(1).match(reg);  
              if (r != null) return unescape(r[2]); return null; 
          }

          function displayAlert(parent,id,text,type='danger',closePrevious=true){
            var alert = $('#'+id);
            if(alert && closePrevious){
              alert.remove();
            }
            $(parent).append('<div id="'+id+'" class="alert alert-'+type+' font-monospace" style="font-size:0.75rem;padding-top:0.5rem!important;padding-bottom:0.5rem!important" role="alert">'
              +text+'</div>');
          }

          var signupForm = $('#signup');
          var loginForm = $('#login');
          
          loginForm.hide();
          signupForm.hide();

          if(getUrlParam('act')){//signup
            signupForm.fadeIn(1000);
          }
          else{//login
            $('#l_username').val(Cookies.get('username'));
            $('#l_password').val(Cookies.get('password'));
            loginForm.fadeIn(1000);
          }

          function redirect(user){
            processing = true;
            Cookies.set('username', user.username, { expires: 7, path: '/' })
            Cookies.set('password', user.password, { expires: 7, path: '/' })
            Cookies.set('public_key', user.public_key, { expires: 7, path: '/' })
            Cookies.set('private_key', user.private_key, { expires: 7, path: '/' })
            setTimeout(()=>{window.location.href = "/dashboard/index.html";},1000);
          }

          var processing = false;
          function login(){
            if(processing)return;
            processing = true;

            var username = $('#l_username').val();
            var password = $('#l_password').val();

            if(username.length < 5 || username.includes(" ")){
              displayAlert("#loginAlert","l_alert",'{"status":"invalid username"}');
                    return;
            }

            if(password.length < 8 || password.length > 255){
              displayAlert("#loginAlert","l_alert",'{"status":"invalid password"}');
                    return;
            }

            displayAlert("#loginAlert","l_alert",'<pre style="margin-bottom:0 !important"><code>curl -d "username='+username+'&password='+password+'" -X POST /login</code></pre>','secondary');
            
            $.ajax({
              type: "POST",
              async: true,
              url: "/login",
              cache: false,
              data: {
                  username,
                  password
              },
              success: function(result){
                processing = false;
                var status = result.status;
                if(status != "success"){ //error
                    // Already exists -> show an alert (keep it as json make it looks like hacker smh)
                    displayAlert("#loginAlert","l_alert",JSON.stringify(result));
                    return;
                }
                // continue
                var user = result.user;
                displayAlert("#loginAlert","l_alert",'Success!<br><pre style="margin-bottom:0 !important"><code>'+JSON.stringify(user,null,2)+'</code></pre>','success');
                displayAlert("#loginAlert","l_alert",'Redirecting to the user portal in 1 second','primary',false);
                redirect(user);
              },
            });
          }

          function signup(){
            if(processing)return;
            processing = true;

            var username = $('#s_username').val();
            var password = $('#s_password').val();

            if(username.length < 5 || username.includes(" ")){
              displayAlert("#signupAlert","s_alert",'{"status":"invalid username"}');
                    return;
            }

            if(password.length < 8 || password.length > 255){
              displayAlert("#signupAlert","s_alert",'{"status":"invalid password"}');
                    return;
            }

            displayAlert("#signupAlert","s_alert",'<pre style="margin-bottom:0 !important"><code>curl -d "username='+username+'&password='+password+'" -X POST /create_account</code></pre>','secondary');
            
            $.ajax({
              type: "POST",
              async: true,
              url: "/create_account",
              cache: false,
              data: {
                  username,
                  password
              },
              success: function(result){
                processing = false;
                var status = result.status;
                if(status != "success"){ //error
                    // Already exists -> show an alert (keep it as json make it looks like hacker smh)
                    displayAlert("#signupAlert","s_alert",JSON.stringify(result));
                    return;
                }
                // continue
                var user = result.user;
                displayAlert("#signupAlert","s_alert",'Success!<br><pre style="margin-bottom:0 !important"><code>'+JSON.stringify(user,null,2)+'</code></pre>','success');
                displayAlert("#signupAlert","s_alert",'Redirecting to the user portal in 1 second','primary',false);
                redirect(user);
              },
            });
          }
      </script>
  </body>
</html>